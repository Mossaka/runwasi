# yaml-language-server: $schema=https://json.schemastore.org/github-action.json

name: Signing

on:
  workflow_call:
    inputs:
      runtime:
        required: true
        type: string
      path: 
        required: true
        type: string
jobs:
  sign:
    name: Sign the binaries
    runs-on: "ubuntu-latest"
    steps:
    - uses: actions/checkout@v4
    - name: Setup cosign for signing
      uses: sigstore/cosign-installer@v3.3.0
      with:
        cosign-release: 'v2.2.2'
    - name: Sign the binaries
      run: |
        make dist-${{ inputs.runtime }}
        # Check if there's any files to archive as tar fails otherwise
        if stat ${{ inputs.path }}/* >/dev/null 2>&1; then
          echo "::notice::Signing the binary"
          cosign sign-blob --yes \
            --output-signature containerd-shim-${{ inputs.runtime }}-v1.sig \
            --output-certificate containerd-shim-${{ inputs.runtime }}-v1.pem \
            --bundle containerd-shim-${{ inputs.runtime }}-v1.bundle \
            ${{ inputs.path }}/containerd-shim-${{ inputs.runtime }}-v1
          
          cosign sign-blob --yes \
            --output-signature containerd-shim-${{ inputs.runtime }}d-v1.sig \
            --output-certificate containerd-shim-${{ inputs.runtime }}d-v1.pem \
            --bundle containerd-shim-${{ inputs.runtime }}d-v1.bundle \
            ${{ inputs.path }}/containerd-shim-${{ inputs.runtime }}d-v1

          cosign sign-blob --yes \
            --output-signature containerd-${{ inputs.runtime }}d.sig \
            --output-certificate containerd-${{ inputs.runtime }}d.pem \
            --bundle containerd-${{ inputs.runtime }}d.bundle \
            ${{ inputs.path }}/containerd-${{ inputs.runtime }}d
          
          # Copy the certs to the dist/bin folder
          cp *.sig ${{ inputs.path }}/
          cp *.pem ${{ inputs.path }}/
        else
          echo "::warning::No files to sign"
        fi